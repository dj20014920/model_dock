# ğŸ¯ iframe ì„¸ì…˜ ì™„ë²½ ë³´ì¡´ ì‹œìŠ¤í…œ - í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ğŸ“‹ êµ¬í˜„ ì™„ë£Œ ë‚´ìš©

### âœ… í•µì‹¬ ë³€ê²½ì‚¬í•­
1. **MultiBotChatPanel ì™„ì „ ì¬êµ¬ì„±**
   - ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” 5ê°œ ë ˆê±°ì‹œ ì»´í¬ë„ŒíŠ¸ ì œê±° (TwoBotChatPanel, ThreeBotChatPanel, etc.)
   - ìƒˆë¡œìš´ UnifiedChatPanel ì•„í‚¤í…ì²˜ ë„ì…
   - ëª¨ë“  iframe ë´‡(chatgpt, grok, qwen, lmarena)ì„ í•­ìƒ ë Œë”ë§
   - CSS `display:none`ìœ¼ë¡œë§Œ í‘œì‹œ/ìˆ¨ê¹€ ì œì–´

2. **CSS ê¸°ë°˜ ê°€ì‹œì„± ì œì–´**
   - iframe ë´‡: í•­ìƒ DOMì— ì¡´ì¬, `hidden` í´ë˜ìŠ¤ë¡œë§Œ ì œì–´
   - ë©”ì¸ë¸Œë ˆì¸ ì˜ì—­: í•­ìƒ ë Œë”ë§, `hidden` í´ë˜ìŠ¤ë¡œë§Œ ì œì–´
   - ë¹„-iframe ë´‡: ì¡°ê±´ë¶€ ë Œë”ë§ ìœ ì§€ (Jotaiê°€ ì„¸ì…˜ ë³´ì¡´)

3. **ì•ˆì •ì ì¸ Key ì „ëµ**
   - `${botId}-${index}` â†’ `botId`ë¡œ ë³€ê²½
   - React Reconciliation ìµœì í™”

### ğŸ”§ ê¸°ìˆ ì  ì›ë¦¬

#### Before (ë¬¸ì œ ìƒí™©):
```tsx
// hasMainBrain ë³€ê²½ ì‹œ ì™„ì „íˆ ë‹¤ë¥¸ JSX êµ¬ì¡° ë°˜í™˜
if (hasMainBrain) {
  return <div className="flex-row">...</div>  // êµ¬ì¡° A
} else {
  return <div className="w-full">...</div>    // êµ¬ì¡° B
}
// â†’ Reactê°€ unmount/mount ê°ì§€ â†’ PersistentIframe unmount â†’ iframe reload
```

#### After (í•´ê²° ë°©ë²•):
```tsx
// í•­ìƒ ê°™ì€ êµ¬ì¡°, CSSë¡œë§Œ ì œì–´
return (
  <div className="flex flex-row">
    <div className={hasMainBrain ? 'flex-1' : 'w-full'}>
      {/* iframe ë´‡ë“¤ í•­ìƒ ë Œë”ë§ */}
      {otherChats.map(chat => (
        <div className={isIframe && !isVisible && 'hidden'}>
          <ConversationPanel ... />
        </div>
      ))}
    </div>
    <div className={!hasMainBrain && 'hidden'}>
      {/* ë©”ì¸ë¸Œë ˆì¸ ì˜ì—­ í•­ìƒ ë Œë”ë§ */}
    </div>
  </div>
)
// â†’ Reactê°€ ê°™ì€ ì»´í¬ë„ŒíŠ¸ë¡œ ì¸ì‹ â†’ PersistentIframe ìœ ì§€ â†’ ì„¸ì…˜ ë³´ì¡´!
```

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì¤€ë¹„ ë‹¨ê³„
```bash
# 1. ë¹Œë“œ ì™„ë£Œ í™•ì¸
yarn build
# âœ… ì´ë¯¸ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œë¨!

# 2. ê°œë°œ ì„œë²„ ì‹¤í–‰
yarn dev
```

### ì‹œë‚˜ë¦¬ì˜¤ 1: ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ì „í™˜
**ëª©í‘œ**: 2 â†’ 3 â†’ 4 â†’ 6 ê·¸ë¦¬ë“œ ì „í™˜ ì‹œ ëª¨ë“  iframe ë´‡ì˜ ì„¸ì…˜ ìœ ì§€

1. ChatGPT íƒ­ì—ì„œ "ì•ˆë…•í•˜ì„¸ìš”"ë¼ê³  ì…ë ¥í•˜ê³  ëŒ€í™” ì‹œì‘
2. ì¢Œì¸¡ í•˜ë‹¨ ë ˆì´ì•„ì›ƒ ìŠ¤ìœ„ì¹˜ì—ì„œ 2 â†’ 3 â†’ 4 â†’ 6 ìˆœì„œë¡œ ë³€ê²½
3. **ì˜ˆìƒ ê²°ê³¼**: ê° ì „í™˜ë§ˆë‹¤ ChatGPT iframeì´ reloadë˜ì§€ ì•Šê³  ëŒ€í™” ë‚´ì—­ ìœ ì§€

**ì½˜ì†” ë¡œê·¸ í™•ì¸**:
```
[PersistentIframe] ğŸ”§ attach (embedded) begin { botId: 'chatgpt', containerId: ... }
[PersistentIframe] âœ… ë§ˆìš´íŠ¸ ì™„ë£Œ { botId: 'chatgpt', zoom: 1 }

// ë ˆì´ì•„ì›ƒ ë³€ê²½ ì‹œ
[Layout] ğŸ” switch_all_in_one_layout { prev: 2, next: 3 }
[UnifiedChatPanel] ğŸ¨ Render: { layout: 3, ... }

// âŒ ë‹¤ìŒ ë¡œê·¸ê°€ ë‚˜ì˜¤ë©´ ì•ˆ ë¨:
[PersistentIframe] ğŸ§¹ detach (embedded) begin
[PersistentIframe] ğŸ”§ attach (embedded) begin  (ì¬ë¶€ì°©)
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë©”ì¸ë¸Œë ˆì¸ ë“±ë¡/í•´ì œ
**ëª©í‘œ**: ë©”ì¸ë¸Œë ˆì¸ ì„¤ì •/í•´ì œ ì‹œ iframe ì„¸ì…˜ ìœ ì§€

1. Grok iframeì—ì„œ ëŒ€í™” ì‹œì‘ (ë¡œê·¸ì¸ í•„ìš”)
2. ìš°ì¸¡ ìƒë‹¨ ë©”ì¸ë¸Œë ˆì¸ íŒ¨ë„ì—ì„œ Grokì„ ë©”ì¸ë¸Œë ˆì¸ìœ¼ë¡œ ë“±ë¡
3. **ì˜ˆìƒ ê²°ê³¼**: Grok iframeì´ ìš°ì¸¡ìœ¼ë¡œ ì´ë™í•˜ì§€ë§Œ reload ì—†ìŒ (ì„¸ì…˜ ìœ ì§€)
4. ë©”ì¸ë¸Œë ˆì¸ í•´ì œ
5. **ì˜ˆìƒ ê²°ê³¼**: Grok iframeì´ ì¢Œì¸¡ ê·¸ë¦¬ë“œë¡œ ëŒì•„ê°€ì§€ë§Œ reload ì—†ìŒ

**ì½˜ì†” ë¡œê·¸ í™•ì¸**:
```
[MultiBotPanel] ğŸ”„ Main Brain change: { from: '', to: 'grok' }
[MultiBotPanel] ğŸ“Š Layout State: { hasMainBrain: true, mainBrainChat: 'grok', ... }

// âŒ PersistentIframeì˜ detach/attach ë¡œê·¸ê°€ ë‚˜ì˜¤ë©´ ì•ˆ ë¨
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë©”ì¸ë¸Œë ˆì¸ ë³€ê²½
**ëª©í‘œ**: ë©”ì¸ë¸Œë ˆì¸ì„ ë‹¤ë¥¸ ë´‡ìœ¼ë¡œ ë³€ê²½ ì‹œ ë‘ ë´‡ ëª¨ë‘ ì„¸ì…˜ ìœ ì§€

1. ChatGPTë¥¼ ë©”ì¸ë¸Œë ˆì¸ìœ¼ë¡œ ë“±ë¡í•˜ê³  ëŒ€í™” ì‹œì‘
2. Qwen iframeì—ì„œë„ ëŒ€í™” ì‹œì‘
3. ë©”ì¸ë¸Œë ˆì¸ì„ ChatGPT â†’ Qwenìœ¼ë¡œ ë³€ê²½
4. **ì˜ˆìƒ ê²°ê³¼**:
   - ChatGPTê°€ ì¢Œì¸¡ ê·¸ë¦¬ë“œë¡œ ì´ë™í•˜ì§€ë§Œ ëŒ€í™” ë‚´ì—­ ìœ ì§€
   - Qwenì´ ìš°ì¸¡ìœ¼ë¡œ ì´ë™í•˜ì§€ë§Œ ëŒ€í™” ë‚´ì—­ ìœ ì§€

### ì‹œë‚˜ë¦¬ì˜¤ 4: ëŒ€í™”ëª¨ë“œ ì „í™˜ (ë§Œì•½ êµ¬í˜„ë˜ì–´ ìˆë‹¤ë©´)
**ëª©í‘œ**: ì˜¬ì¸ì› ëª¨ë“œ â†” ê°œë³„ ëª¨ë“œ ì „í™˜ ì‹œ ì„¸ì…˜ ìœ ì§€

1. ì˜¬ì¸ì› ëª¨ë“œì—ì„œ ChatGPT, Grok ëŒ€í™” ì‹œì‘
2. ê°œë³„ ëª¨ë“œë¡œ ì „í™˜
3. **ì˜ˆìƒ ê²°ê³¼**: ê° ë´‡ì˜ ëŒ€í™” ë‚´ì—­ ìœ ì§€
4. ë‹¤ì‹œ ì˜¬ì¸ì› ëª¨ë“œë¡œ ì „í™˜
5. **ì˜ˆìƒ ê²°ê³¼**: ëª¨ë“  ëŒ€í™” ë‚´ì—­ ìœ ì§€

## ğŸ” ë””ë²„ê¹… ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì •ìƒ ì‘ë™ ì‹ í˜¸ âœ…
- [ ] `[UnifiedChatPanel] ğŸ¨ Render` ë¡œê·¸ê°€ ë ˆì´ì•„ì›ƒ ë³€ê²½ ì‹œë§ˆë‹¤ ì¶œë ¥
- [ ] `[MultiBotPanel] ğŸ“Š Layout State` ë¡œê·¸ê°€ ìƒíƒœ ë³€í™”ë¥¼ ì¶”ì 
- [ ] `[PersistentIframe] ğŸ”§ attach` ë¡œê·¸ê°€ ìµœì´ˆ 1íšŒë§Œ ì¶œë ¥
- [ ] iframe ë‚´ë¶€ URLì´ ë³€ê²½ë˜ì§€ ì•ŠìŒ (ê°œë°œì ë„êµ¬ > Elements íƒ­ í™•ì¸)

### ë¬¸ì œ ì‹ í˜¸ âŒ
- [ ] `[PersistentIframe] ğŸ§¹ detach` ë¡œê·¸ê°€ ë ˆì´ì•„ì›ƒ ë³€ê²½ ì‹œ ì¶œë ¥
- [ ] `[PersistentIframe] ğŸ”§ attach` ë¡œê·¸ê°€ ë°˜ë³µ ì¶œë ¥
- [ ] iframeì´ ê¹œë¹¡ì´ê±°ë‚˜ ìƒˆë¡œê³ ì¹¨ë¨
- [ ] ëŒ€í™” ë‚´ì—­ì´ ì‚¬ë¼ì§

## ğŸ“Š ì„±ëŠ¥ ì²´í¬

### ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
```bash
# Chrome DevTools > Performance > Memory
1. í”„ë¡œíŒŒì¼ë§ ì‹œì‘
2. ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
3. í”„ë¡œíŒŒì¼ë§ ì¢…ë£Œ
4. ë©”ëª¨ë¦¬ ì¦ê°€ëŸ‰ í™•ì¸

# ì˜ˆìƒ ë©”ëª¨ë¦¬ ì¦ê°€: ~200MB (iframe 4ê°œ ìƒì‹œ ë Œë”ë§)
```

### PERF-WARNING í™•ì¸
íŒŒì¼: `src/app/pages/MultiBotChatPanel.tsx:556-557`
```typescript
// PERF-WARNING: iframe ë´‡ 4ê°œ ìƒì‹œ ë Œë”ë§ìœ¼ë¡œ ë©”ëª¨ë¦¬ +200MB ì˜ˆìƒ
// í™•ì¸: Instruments > Allocationsë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
```

## ğŸ‰ ì„±ê³µ ê¸°ì¤€

### âœ… ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ:
1. iframeì´ reloadë˜ì§€ ì•ŠìŒ
2. ëŒ€í™” ë‚´ì—­ì´ ìœ ì§€ë¨
3. ë¡œê·¸ì¸ ìƒíƒœê°€ ìœ ì§€ë¨
4. ì½˜ì†”ì— detach/attach ë¡œê·¸ê°€ ë°˜ë³µë˜ì§€ ì•ŠìŒ

### âœ… ì½”ë“œ í’ˆì§ˆ:
1. TypeScript ë¹Œë“œ ì—ëŸ¬ ì—†ìŒ (âœ… ì´ë¯¸ í™•ì¸ë¨)
2. React Hooks ê·œì¹™ ì¤€ìˆ˜ (âœ… ëª¨ë“  ë´‡ì— ëŒ€í•´ í•­ìƒ ê°™ì€ ìˆœì„œë¡œ useChat í˜¸ì¶œ)
3. KISS, DRY, YAGNI, SOLID ì›ì¹™ ì¤€ìˆ˜ (âœ… ìµœì†Œ ì½”ë“œë¡œ ìµœëŒ€ íš¨ê³¼)

## ğŸ›  ë¬¸ì œ ë°œìƒ ì‹œ ì¡°ì¹˜

### ë¬¸ì œ: iframeì´ ì—¬ì „íˆ reloadë¨
**ì›ì¸ ë¶„ì„**:
1. `visibilityMap` ìƒì„± ë¡œì§ í™•ì¸
2. `isIframeBot()` í•¨ìˆ˜ ë™ì‘ í™•ì¸
3. React DevTools > Componentsì—ì„œ ConversationPanelì˜ props ë³€í™” ì¶”ì 

**í•´ê²° ë°©ì•ˆ**:
```typescript
// UnifiedChatPanelì—ì„œ visibilityMap ë¡œê¹… ì¶”ê°€
console.log('[UnifiedChatPanel] visibilityMap:', Array.from(visibilityMap.entries()))
```

### ë¬¸ì œ: íŠ¹ì • ë´‡ë§Œ ì„¸ì…˜ì´ ìœ ì§€ë˜ì§€ ì•ŠìŒ
**ì›ì¸**: iframe-registry.tsì— ë“±ë¡ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì˜ëª» ë“±ë¡ë¨

**í™•ì¸**:
```bash
# iframe ë´‡ ëª©ë¡ í™•ì¸
cat src/app/bots/iframe-registry.ts
```

### ë¬¸ì œ: ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°œìƒ
**ì›ì¸**: iframeManagerì˜ stashì— iframeì´ ê³„ì† ìŒ“ì„

**í•´ê²°**:
```typescript
// í•„ìš” ì‹œ cleanup í˜¸ì¶œ (ë‹¨, ì„¸ì…˜ì€ ì†ì‹¤ë¨)
iframeManager.cleanup()
```

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

### ì¶”ê°€ ìµœì í™” ê³ ë ¤ì‚¬í•­
1. **Lazy Loading**: ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ í´ë¦­í•  ë•Œê¹Œì§€ iframe ë¡œë“œ ì§€ì—°
2. **Virtual Scrolling**: ë§ì€ ë´‡ì´ ì¶”ê°€ë  ê²½ìš° ì„±ëŠ¥ ìµœì í™”
3. **Service Worker Caching**: iframe ë¦¬ì†ŒìŠ¤ ìºì‹±ìœ¼ë¡œ ì´ˆê¸° ë¡œë“œ ì†ë„ ê°œì„ 

### ë¬¸ì„œí™”
- [x] í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ ì‘ì„±
- [ ] ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€
- [ ] API ë¬¸ì„œ ì—…ë°ì´íŠ¸

---

**ì‘ì„±ì¼**: 2025-10-31
**ì‘ì„±ì**: Claude Code (Sonnet 4.5)
**êµ¬í˜„ ì›ì¹™**: KISS, DRY, YAGNI, SOLID
**ê²€ì¦ ìƒíƒœ**: TypeScript ë¹Œë“œ ì„±ê³µ âœ…
